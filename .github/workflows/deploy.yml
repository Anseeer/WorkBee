# name: CI & CD (Delivery) for WorkBee

# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# env:
#   FRONTEND_DIR: Frontend
#   BACKEND_DIR: Backend
#   REGION: ${{ secrets.CLOUD_RUN_REGION }}
#   PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
#   DOCKERHUB_USER: ${{ secrets.DOCKER_USERNAME }}

# jobs:
#   ci:
#     name: CI - build, test, docker build & push
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up QEMU (for buildx)
#         uses: docker/setup-qemu-action@v2

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v2

#       - name: Login to Docker Hub
#         uses: docker/login-action@v2
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       - name: Build frontend (install & build)
#         working-directory: ${{ env.FRONTEND_DIR }}
#         run: |
#           npm ci
#           npm run build || true

#       - name: Build backend (install & build)
#         working-directory: ${{ env.BACKEND_DIR }}
#         run: |
#           npm ci
#           npm run build || true

#       - name: Set image tags
#         run: |
#           echo "FRONT_IMG=${{ env.DOCKERHUB_USER }}/workbee-frontend:${GITHUB_SHA}" >> $GITHUB_ENV
#           echo "BACK_IMG=${{ env.DOCKERHUB_USER }}/workbee-backend:${GITHUB_SHA}" >> $GITHUB_ENV

#       - name: Build & push frontend Docker image
#         working-directory: ${{ env.FRONTEND_DIR }}
#         run: |
#           docker buildx build --platform linux/amd64,linux/arm64 \
#             -t "$FRONT_IMG" \
#             --push .

#       - name: Build & push backend Docker image
#         working-directory: ${{ env.BACKEND_DIR }}
#         run: |
#           docker buildx build --platform linux/amd64,linux/arm64 \
#             -t "$BACK_IMG" \
#             --push .

#       - name: CI summary
#         run: |
#           echo "Frontend image pushed: $FRONT_IMG"
#           echo "Backend image pushed: $BACK_IMG"

#   deliver:
#     name: CD - Deploy to Cloud Run (manual approval)
#     needs: ci
#     runs-on: ubuntu-latest
#     environment:
#       name: production
#       url: https://console.cloud.google.com/run
#     concurrency: production-deploy

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Authenticate to Google Cloud
#         uses: google-github-actions/auth@v2
#         with:
#           credentials_json: ${{ secrets.GCP_SA_KEY }}

#       - name: Set gcloud project
#         run: gcloud config set project ${{ env.PROJECT_ID }}

#       - name: Deploy backend to Cloud Run
#         run: |
#           gcloud run deploy workbee-backend \
#             --image="docker.io/${{ env.DOCKERHUB_USER }}/workbee-backend:${{ github.sha }}" \
#             --region="${{ env.REGION }}" \
#             --platform=managed \
#             --allow-unauthenticated \
#             --port=8080 \
#             --timeout=600s \
#             --no-cpu-throttling \
#             --max-instances=3 \
#             --set-env-vars="\
#             MONGODB_URI=${{ secrets.MONGODB_URI }},\
#             JWT_SECRET=${{ secrets.JWT_SECRET }},\
#             JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }},\
#             JWT_REFRESH_EXPIRES_IN=${{ secrets.JWT_REFRESH_EXPIRES_IN }},\
#             JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }},\
#             NODE_EMAIL=${{ secrets.NODE_EMAIL }},\
#             NODE_EMAIL_PASS=${{ secrets.NODE_EMAIL_PASS }},\
#             GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }},\
#             RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }},\
#             RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }},\
#             TOKEN_MAX_AGE=${{ secrets.TOKEN_MAX_AGE }},\
#             REFRESH_TOKEN_MAX_AGE=${{ secrets.REFRESH_TOKEN_MAX_AGE }},\
#             RAZORPAYX_ACCOUNT=${{ secrets.RAZORPAYX_ACCOUNT }},\
#             CLIENT_URL_DOCKER=${{ secrets.CLIENT_URL_DOCKER }},\
#             CLIENT_URL_HOST=${{ secrets.CLIENT_URL_HOST }}" \
#                         --quiet

#       - name: Deploy frontend to Cloud Run
#         run: |
#           gcloud run deploy workbee-frontend \
#             --image="${{ env.DOCKERHUB_USER }}/workbee-frontend:${{ github.sha }}" \
#             --region="${{ env.REGION }}" \
#             --platform=managed \
#             --allow-unauthenticated \
#             --port=80 \
#             --timeout=600s \
#             --no-cpu-throttling \
#             --max-instances=3 \
#             --set-env-vars="\
#             VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }},\
#             VITE_GOOGLE_MAP_API_KEY=${{ secrets.VITE_GOOGLE_MAP_API_KEY }},\
#             VITE_GOOGLE_CLIENT_ID=${{ secrets.VITE_GOOGLE_CLIENT_ID }},\
#             GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }},\
#             VITE_RAZORPAY_KEY_ID=${{ secrets.VITE_RAZORPAY_KEY_ID }},\
#             VITE_CLOUDNARY_URL=${{ secrets.VITE_CLOUDNARY_URL }},\
#             VITE_PORT=${{ secrets.VITE_PORT }},\
#             VITE_SOCKET_URL=${{ secrets.VITE_SOCKET_URL }}" \
#                         --quiet


name: CI & CD (Delivery) for WorkBee

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  FRONTEND_DIR: Frontend
  BACKEND_DIR: Backend
  REGION: ${{ secrets.CLOUD_RUN_REGION }}
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  DOCKERHUB_USER: ${{ secrets.DOCKER_USERNAME }}

jobs:
  ci:
    name: CI - build, test, docker build & push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (for buildx)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ✅ Build frontend
      - name: Build frontend (install & build)
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          npm ci
          npm run build

      # ✅ Build backend
      - name: Build backend (install & build)
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          npm ci
          npm run build

      - name: Set image tags
        run: |
          echo "FRONT_IMG=${{ env.DOCKERHUB_USER }}/workbee-frontend:${GITHUB_SHA}" >> $GITHUB_ENV
          echo "BACK_IMG=${{ env.DOCKERHUB_USER }}/workbee-backend:${GITHUB_SHA}" >> $GITHUB_ENV

      # ✅ Build & push frontend Docker image
      - name: Build & push frontend Docker image
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t "$FRONT_IMG" \
            --push .

      # ✅ Build & push backend Docker image
      - name: Build & push backend Docker image
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t "$BACK_IMG" \
            --push .

      - name: CI summary
        run: |
          echo "Frontend image pushed: $FRONT_IMG"
          echo "Backend image pushed: $BACK_IMG"

  deliver:
    name: CD - Deploy to Cloud Run (manual approval)
    needs: ci
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://console.cloud.google.com/run
    concurrency: production-deploy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set gcloud project
        run: gcloud config set project ${{ env.PROJECT_ID }}

      # ✅ Deploy backend (keep secrets safe)
      - name: Deploy backend to Cloud Run
        run: |
          gcloud run deploy workbee-backend \
            --image="docker.io/${{ env.DOCKERHUB_USER }}/workbee-backend:${{ github.sha }}" \
            --region="${{ env.REGION }}" \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --timeout=600s \
            --no-cpu-throttling \
            --max-instances=3 \
            --set-env-vars="\
            MONGODB_URI=${{ secrets.MONGODB_URI }},\
            JWT_SECRET=${{ secrets.JWT_SECRET }},\
            JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }},\
            JWT_REFRESH_EXPIRES_IN=${{ secrets.JWT_REFRESH_EXPIRES_IN }},\
            JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }},\
            NODE_EMAIL=${{ secrets.NODE_EMAIL }},\
            NODE_EMAIL_PASS=${{ secrets.NODE_EMAIL_PASS }},\
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }},\
            RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }},\
            RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }},\
            TOKEN_MAX_AGE=${{ secrets.TOKEN_MAX_AGE }},\
            REFRESH_TOKEN_MAX_AGE=${{ secrets.REFRESH_TOKEN_MAX_AGE }},\
            RAZORPAYX_ACCOUNT=${{ secrets.RAZORPAYX_ACCOUNT }},\
            CLIENT_URL_DOCKER=${{ secrets.CLIENT_URL_DOCKER }},\
            CLIENT_URL_HOST=${{ secrets.CLIENT_URL_HOST }}" \
            --quiet

      # ✅ Deploy frontend (no secrets needed now)
      - name: Deploy frontend to Cloud Run
        run: |
          gcloud run deploy workbee-frontend \
            --image="${{ env.DOCKERHUB_USER }}/workbee-frontend:${{ github.sha }}" \
            --region="${{ env.REGION }}" \
            --platform=managed \
            --allow-unauthenticated \
            --port=80 \
            --timeout=600s \
            --no-cpu-throttling \
            --max-instances=3 \
            --quiet
